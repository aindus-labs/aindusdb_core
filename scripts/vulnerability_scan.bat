# @echo off
REM üîç vulnerability_scan.bat - Scanner de vuln√©rabilit√©s Windows
echo.
echo üîç SCANNER DE VULN√âRABILIT√âS - AindusDB Core
echo ==========================================

REM Cr√©er le r√©pertoire des rapports
if not exist "security_reports" mkdir security_reports

REM V√©rifier si l'environnement virtuel existe
if exist "..\.venv\Scripts\activate.bat" (
    echo üì¶ Utilisation de l'environnement virtuel...
    call ..\.venv\Scripts\activate.bat
    set PYTHON_CMD=python
) else (
    REM V√©rifier Python global
    py --version >nul 2>&1
    if errorlevel 1 (
        echo ‚ùå Python non trouv√©
        pause
        exit /b 1
    )
    set PYTHON_CMD=py
)

REM Installer les outils de s√©curit√©
echo.
echo üì¶ Installation des outils de s√©curit√©...
%PYTHON_CMD% -m pip install safety bandit semgrep

REM Scanner les d√©pendances Python
echo.
echo üêç Scan des d√©pendances Python...
echo   ‚Ä¢ Safety (vuln√©rabilit√©s connues)...
%PYTHON_CMD% -m safety check --json --output safety_report.json 2>nul || %PYTHON_CMD% -m safety check --output safety_report.txt

echo   ‚Ä¢ Bandit (analyse statique)...
%PYTHON_CMD% -m bandit -r app/ -f json -o bandit_report.json 2>nul || %PYTHON_CMD% -m bandit -r app/ -o bandit_report.txt

echo   ‚Ä¢ Semgrep (r√®gles custom)...
%PYTHON_CMD% -m semgrep --config=auto --json --output=semgrep_report.json app/ 2>nul || %PYTHON_CMD% -m semgrep --config=auto app/ > semgrep_report.txt

REM Scanner les secrets
echo.
echo üîë Scan des secrets et credentials...
echo   ‚Ä¢ Recherche patterns secrets...
findstr /S /I "password secret key token" *.py *.yaml *.yml *.json *.env* > secrets_found.txt 2>nul || echo Aucun pattern trouv√© > secrets_found.txt

REM Scanner la configuration
echo.
echo ‚öôÔ∏è  Scan de la configuration...
if exist ".env" (
    echo   ‚Ä¢ Analyse .env...
    findstr "DEBUG ENVIRONMENT CORS_ORIGINS SSL_ENABLED" .env > config_analysis.txt
)

if exist "docker-compose.yml" (
    echo   ‚Ä¢ Analyse Docker...
    findstr "image ports environment" docker-compose.yml > docker_analysis.txt
)

if exist "requirements.txt" (
    echo   ‚Ä¢ Analyse requirements...
    find /C /V "" requirements.txt > req_count.txt
)

REM Scanner le code source
echo.
echo üìù Scan du code source...
echo   ‚Ä¢ Recherche patterns dangereux...
findstr /S "eval(" app\*.py > dangerous_patterns.txt 2>nul || echo Aucun eval trouv√© > dangerous_patterns.txt
findstr /S "exec(" app\*.py >> dangerous_patterns.txt 2>nul
findstr /S "subprocess.call" app\*.py >> dangerous_patterns.txt 2>nul
findstr /S "os.system" app\*.py >> dangerous_patterns.txt 2>nul

echo   ‚Ä¢ V√©rifications injection SQL...
findstr /S /R "f\".*{.*}.*SELECT" app\*.py > sqli_patterns.txt 2>nul || echo Aucun pattern SQLi d√©tect√© > sqli_patterns.txt

REM Compter les vuln√©rabilit√©s
echo.
echo üìä G√©n√©ration du rapport...
set /a SAFETY_ISSUES=0
set /a BANDIT_ISSUES=0
set /a SEMGREP_ISSUES=0
set /a SECRETS_FOUND=0

REM Score de s√©curit√©
set /a TOTAL_ISSUES=%SAFETY_ISSUES%+%BANDIT_ISSUES%+%SEMGREP_ISSUES%+%SECRETS_FOUND%

if %TOTAL_ISSUES% EQU 0 (
    set SECURITY_SCORE=10.0
    set RISK_LEVEL=FAIBLE
    set RISK_COLOR=üü¢
) else if %TOTAL_ISSUES% LEQ 5 (
    set SECURITY_SCORE=8.5
    set RISK_LEVEL=MOYEN
    set RISK_COLOR=üü°
) else if %TOTAL_ISSUES% LEQ 15 (
    set SECURITY_SCORE=6.5
    set RISK_LEVEL=√âLEV√â
    set RISK_COLOR=üü†
) else (
    set SECURITY_SCORE=4.0
    set RISK_LEVEL=CRITIQUE
    set RISK_COLOR=üî¥
)

REM Cr√©er le rapport
echo { > security_reports\vulnerability_scan.json
echo   "scan_date": "%date% %time%", >> security_reports\vulnerability_scan.json
echo   "security_score": "%SECURITY_SCORE%", >> security_reports\vulnerability_scan.json
echo   "risk_level": "%RISK_LEVEL%", >> security_reports\vulnerability_scan.json
echo   "tools_used": ["Safety", "Bandit", "Semgrep"] >> security_reports\vulnerability_scan.json
echo } >> security_reports\vulnerability_scan.json

echo.
echo ==========================================
echo üìä R√âSUM√â DU SCAN
echo ==========================================
echo Score de s√©curit√© : %SECURITY_SCORE%/10 (%RISK_LEVEL% %RISK_COLOR%)
echo Vuln√©rabilit√©s totales : %TOTAL_ISSUES%
echo.
echo üìÑ Rapports d√©taill√©s :
echo   ‚Ä¢ safety_report.txt/.json
echo   ‚Ä¢ bandit_report.txt/.json
echo   ‚Ä¢ semgrep_report.txt/.json
echo   ‚Ä¢ secrets_found.txt
echo   ‚Ä¢ dangerous_patterns.txt
echo.
echo üéØ Actions recommand√©es :
echo 1. Consulter les rapports d√©taill√©s
echo 2. Corriger les vuln√©rabilit√©s critiques
echo 3. Mettre √† jour les d√©pendances
echo 4. Supprimer les secrets expos√©s

pause
